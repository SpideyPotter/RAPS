<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Investment Growth Simulator - RAPS Wealth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#0f172a',
              secondary: '#059669',
              accent: '#0d9488',
            }
          }
        }
      }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-slate-50 text-slate-800 font-sans">

    <!-- Header (Standardized) -->
    <header class="sticky top-0 z-50 bg-white shadow-md border-b border-slate-200">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center h-auto md:h-20 py-4 md:py-0 gap-4 md:gap-0">
                <a href="/" class="flex items-center gap-2">
                    <img src="/static/logo.jpg" alt="RAPS Wealth" class="h-10 w-10 rounded-full object-cover">
                    <div>
                        <h1 class="text-2xl font-bold text-primary tracking-tight">RAPS<span class="text-secondary">Wealth</span></h1>
                        <p class="text-xs text-slate-500 font-medium tracking-widest">FINANCIAL SERVICES</p>
                    </div>
                </a>

                <nav class="flex items-center gap-4 md:gap-8 overflow-x-auto max-w-full pb-2 md:pb-0 w-full md:w-auto justify-center md:justify-end">
                    <a href="/" class="text-slate-600 hover:text-primary text-sm font-semibold whitespace-nowrap transition-colors duration-200">Home</a>
                    <a href="/calculator" class="text-slate-600 hover:text-primary text-sm font-semibold whitespace-nowrap transition-colors duration-200">RAPS Calculator</a>
                    <a href="/growth-simulator" class="text-secondary border-b-2 border-secondary pb-1 text-sm font-semibold whitespace-nowrap transition-colors duration-200">Growth Calculator</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="max-w-5xl mx-auto">
            <!-- Header Section -->
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-primary mb-4">Investment Growth Simulator</h1>
                <p class="text-slate-600">Backtest your investment strategy and see how it would have performed historically</p>
            </div>

            <!-- Input Form -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-8 mb-12">
                <form id="simulator-form" class="space-y-6">
                    <!-- Fund Selection -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Select Fund</label>
                        <div class="relative">
                            <input type="text" id="fund-input" placeholder="Search for a mutual fund..." autocomplete="off"
                                class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-secondary focus:border-transparent outline-none transition-all" />
                            <div id="fund-dropdown" class="absolute top-full left-0 w-full mt-1 bg-white rounded-lg shadow-xl border border-slate-100 hidden z-30 max-h-60 overflow-y-auto custom-scrollbar"></div>
                        </div>
                        <input type="hidden" id="selected-fund" name="fund" required />
                    </div>

                    <!-- Investment Type -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">Investment Type</label>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="investment_type" value="lumpsum" checked class="w-4 h-4 text-secondary focus:ring-secondary" />
                                <span class="ml-2 text-slate-700">Lump Sum (One-time)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="investment_type" value="sip" class="w-4 h-4 text-secondary focus:ring-secondary" />
                                <span class="ml-2 text-slate-700">SIP (Monthly)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Amount (₹)</label>
                        <input type="number" name="amount" id="amount" value="100000" min="1000" step="1000" required
                            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-secondary focus:border-transparent outline-none transition-all" />
                    </div>

                    <!-- Duration -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Backtest Duration</label>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <button type="button" onclick="selectDuration(1)" class="duration-btn px-4 py-2 rounded-lg border-2 border-slate-300 text-slate-700 hover:border-secondary hover:text-secondary transition-all">1 Year</button>
                            <button type="button" onclick="selectDuration(3)" class="duration-btn px-4 py-2 rounded-lg border-2 border-slate-300 text-slate-700 hover:border-secondary hover:text-secondary transition-all">3 Years</button>
                            <button type="button" onclick="selectDuration(5)" class="duration-btn px-4 py-2 rounded-lg border-2 border-secondary text-secondary transition-all font-semibold">5 Years</button>
                            <button type="button" onclick="selectDuration(10)" class="duration-btn px-4 py-2 rounded-lg border-2 border-slate-300 text-slate-700 hover:border-secondary hover:text-secondary transition-all">10 Years</button>
                            <button type="button" onclick="selectDuration(0)" class="duration-btn px-4 py-2 rounded-lg border-2 border-slate-300 text-slate-700 hover:border-secondary hover:text-secondary transition-all">Max</button>
                        </div>
                        <input type="hidden" name="years" id="years" value="5" />
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-center pt-4">
                        <button type="submit" class="bg-secondary hover:bg-emerald-600 text-white px-8 py-3 rounded-lg font-bold text-lg shadow-lg shadow-emerald-900/20 transition-all flex items-center gap-2">
                            <i data-lucide="trending-up" class="w-5 h-5"></i> Simulate Investment
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="results-area" class="hidden space-y-8">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-2">Total Invested</div>
                        <div class="text-2xl font-bold text-slate-800" id="total-invested">₹0</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-2">Current Value</div>
                        <div class="text-2xl font-bold text-secondary" id="current-value">₹0</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                        <div class="text-xs text-slate-500 uppercase tracking-wide mb-2">Absolute Return</div>
                        <div class="text-2xl font-bold" id="absolute-return">0%</div>
                    </div>
                </div>

                <!-- Chart Section -->
                <section class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="bg-slate-50 px-6 py-4 border-b border-slate-100">
                        <h3 class="font-bold text-lg text-primary flex items-center gap-2">
                            <i data-lucide="line-chart" class="w-5 h-5 text-secondary"></i> Investment Growth Over Time
                        </h3>
                    </div>
                    <div class="p-6 flex justify-center bg-white">
                        <img id="chart-img" class="max-w-full h-auto rounded-lg border border-slate-100" alt="Growth Chart" />
                    </div>
                </section>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-secondary"></div>
                <p class="mt-4 text-slate-600">Calculating your investment growth...</p>
            </div>
        </div>
    </main>

    <script>
      lucide.createIcons();

      let allFunds = [];

      // Fetch funds on load
      fetch("/api/funds")
        .then(res => res.json())
        .then(data => {
          allFunds = data;
          console.log(`Loaded ${allFunds.length} funds`);
        })
        .catch(err => console.error("Failed to load funds:", err));

      // Fund search
      const fundInput = document.getElementById("fund-input");
      const fundDropdown = document.getElementById("fund-dropdown");
      const selectedFundInput = document.getElementById("selected-fund");

      fundInput.addEventListener("input", (e) => {
        const val = e.target.value.trim();
        
        if (val.length < 3) {
          fundDropdown.classList.add("hidden");
          return;
        }

        const matches = allFunds.filter(fund =>
          fund.toLowerCase().includes(val.toLowerCase())
        );

        if (matches.length > 0) {
          fundDropdown.innerHTML = matches.slice(0, 10).map(fund => `
            <div onclick="selectFund('${fund.replace(/'/g, "\\'")}')" class="px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 last:border-0 transition-colors">
              <span class="text-slate-700 font-medium">${fund}</span>
            </div>
          `).join('');
          fundDropdown.classList.remove("hidden");
        } else {
          fundDropdown.innerHTML = `<div class="px-4 py-3 text-slate-400 italic">No funds found</div>`;
          fundDropdown.classList.remove("hidden");
        }
      });

      function selectFund(name) {
        fundInput.value = name;
        selectedFundInput.value = name;
        fundDropdown.classList.add("hidden");
      }

      // Duration selection
      function selectDuration(years) {
        document.getElementById("years").value = years;
        
        document.querySelectorAll(".duration-btn").forEach(btn => {
          btn.className = "duration-btn px-4 py-2 rounded-lg border-2 border-slate-300 text-slate-700 hover:border-secondary hover:text-secondary transition-all";
        });
        
        event.target.className = "duration-btn px-4 py-2 rounded-lg border-2 border-secondary text-secondary transition-all font-semibold";
      }

      // Form submission
      document.getElementById("simulator-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const fund = selectedFundInput.value;
        if (!fund) {
          alert("Please select a fund");
          return;
        }

        const formData = new FormData(e.target);
        formData.set("fund", fund);

        // Show loading
        document.getElementById("loading").classList.remove("hidden");
        document.getElementById("results-area").classList.add("hidden");

        try {
          const response = await fetch("/api/simulate-growth", {
            method: "POST",
            body: formData
          });

          const data = await response.json();

          if (data.error) {
            alert(data.error);
            return;
          }

          // Update summary cards
          document.getElementById("total-invested").textContent = data.total_invested;
          document.getElementById("current-value").textContent = data.current_value;
          document.getElementById("absolute-return").textContent = data.absolute_return;
          document.getElementById("absolute-return").style.color = data.is_profit ? '#059669' : '#dc2626';

          // Update chart
          document.getElementById("chart-img").src = "data:image/png;base64," + data.chart;

          // Show results
          document.getElementById("results-area").classList.remove("hidden");
          lucide.createIcons();
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to simulate investment. Please try again.");
        } finally {
          document.getElementById("loading").classList.add("hidden");
        }
      });

      // Close dropdown on outside click
      document.addEventListener("click", (e) => {
        if (!fundInput.contains(e.target) && !fundDropdown.contains(e.target)) {
          fundDropdown.classList.add("hidden");
        }
      });
    </script>
</body>
</html>
